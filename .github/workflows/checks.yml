name: Code Quality Checks & Tests

# develop, main ë¸Œëœì¹˜ë¥¼ ìƒëŒ€ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ìƒì„±ë  ë•Œ CIê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
on:
  pull_request:
    branches:
      - "main"
      - "develop"

jobs:
  # 1. ë¦°íŠ¸ ë° ì •ì  ë¶„ì„ (Linting)
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "${HOME}/.poetry/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        id: cache-venv
        uses: actions/cache@v3
        with:
          # pyproject.tomlê³¼ poetry.lock í•´ì‹œë¥¼ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ìºì‹±
          path: ~/.cache/pypoetry/virtualenvs
          key: python-3.12-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            python-3.12-poetry-

      - name: Install dependencies
        # ìºì‹œê°€ ì—†ê±°ë‚˜ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì„¤ì¹˜
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: poetry install --no-root

      # settings.pyê°€ ë£¨íŠ¸ì˜ .envë¥¼ ë°”ë¼ë³´ë„ë¡ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ë£¨íŠ¸ì— ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Create .env file
        run: |
          echo "${{ secrets.DJANGO_ENVS }}" > .env

      # isort ì œê±° -> Ruffê°€ ëŒ€ì‹  í•¨
      # Ruff ì‹¤í–‰ (Lint + Import Sorting)
      - name: Run Ruff (Lint & Import Sorting)
        run: |
          poetry run ruff check .

      # Black ì‹¤í–‰ (Code Formatting Check)
      - name: Run Black (Code Formatting)
        run: |
          poetry run black . --check

      - name: Run Mypy (Type Checking)
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}z
        run: poetry run mypy .

  # 2. í…ŒìŠ¤íŠ¸ (Tests)
  test:
    needs: ci # ë¦°íŠ¸ ê²€ì‚¬ê°€ í†µê³¼í•´ì•¼ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•¨ (ìì› ì ˆì•½)
    runs-on: ubuntu-latest
    services:
      # DB ì„¤ì •ì„ í”„ë¡œì íŠ¸(.env)ì™€ ì¼ì¹˜ì‹œí‚´
      db:
        image: postgres:15 # ë²„ì „ 15ë¡œ ë³€ê²½
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: oz_playtype_user
          POSTGRES_PASSWORD: oz_playtype_pass
          POSTGRES_DB: oz_playtype_db
          TZ: Asia/Seoul
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # RedisëŠ” í•„ìš” ì—†ë‹¤ë©´ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë˜ì§€ë§Œ, ì¼ë‹¨ ìœ ì§€í•©ë‹ˆë‹¤.
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "${HOME}/.poetry/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        id: cache-venv
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: python-3.12-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            python-3.12-poetry-

      - name: Install dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: poetry install --no-root

      - name: Run Django Migration
        run: |
          poetry run python manage.py migrate

      # Coverage íŒ¨í‚¤ì§€ê°€ í•„ìš”í•˜ë¯€ë¡œ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì„¤ì¹˜ í™•ì¸
      # (pyproject.tomlì— coverageê°€ ì—†ë‹¤ë©´ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤)
      - name: Run Tests & Coverage
        run: |
          # 1. ì „ì²´ í…ŒìŠ¤íŠ¸ ë³‘ë ¬ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ìˆ˜ì§‘
          # (multiprocessing ë“± ë³µì¡í•œ ì˜µì…˜ì€ ì´ˆê¸°ì—” ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆì–´ ë‹¨ìˆœí™”í–ˆìŠµë‹ˆë‹¤)
          poetry run coverage run --source='.' manage.py test
          
          # 2. ê²°ê³¼ ë¦¬í¬íŠ¸ ì¶œë ¥
          echo "======================="
          echo "ğŸ“Š Total Coverage Report:"
          poetry run coverage report -m

          # 3. (ì„ íƒ ì‚¬í•­) apps í´ë” ë‚´ë¶€ ì•±ë³„ ì»¤ë²„ë¦¬ì§€ ì¶œë ¥ ë¡œì§ì€ ìœ ì§€
          apps=$(find apps -maxdepth 1 -mindepth 1 -type d ! -name "__pycache__" -exec basename {} \;)
          
          for app_name in $apps; do
            app_path="apps/$app_name"
            # __init__.pyê°€ ìˆëŠ” í´ë”ë§Œ íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¡œ ê°„ì£¼
            if [ -f "$app_path/__init__.py" ]; then
                echo "ğŸ” Checking coverage for apps.$app_name..."
                # í•´ë‹¹ ì•±ì— ëŒ€í•œ ë¦¬í¬íŠ¸ë§Œ í•„í„°ë§í•´ì„œ ì¶œë ¥
                poetry run coverage report -m --include="$app_path/*" || echo "  - No executed code found in $app_name"
                echo ""
            fi
          done